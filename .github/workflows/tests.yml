name: Quahog Tests
on: [push, pull_request, workflow_dispatch]
jobs:
  tests:
    strategy:
      matrix:
        php-versions: ['8.0', '8.1', '8.2']
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v2"

      - name: "Setup ClamAV"
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq clamav-daemon netcat
          sudo /etc/init.d/clamav-freshclam stop
          sudo sh -c 'echo TCPSocket 3310 >> /etc/clamav/clamd.conf'
          sudo freshclam
          sudo /etc/init.d/clamav-daemon start
          # Wait until ClamAV is running
          timeout 30 sh -c 'until nc -z 127.0.0.1 3310; do echo "Waiting for ClamAV" && sleep 1; done'

      - name: "Setup PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: "mbstring, dom, sockets"

      - name: "Install dependencies with Composer"
        uses: "ramsey/composer-install@v2"
        with:
          composer-options: "--prefer-dist --no-progress --no-suggest"

      - name: Test with phpunit
        run: vendor/bin/phpunit

